import{m as se,u as te,r as o,n as re,t as ae,j as e,A as M,e as T,U as ne,s as I,p as oe,o as $}from"./index-CTR9K_C5.js";import{D as L,Q as B,X as le}from"./DashboardLayout-ChN58qoY.js";import{S as O,Q as ie}from"./QRScanner-B8cxYmV7.js";import{X as q}from"./x-circle-BEsrRhs5.js";import{C as X}from"./calendar-CLr0XUdv.js";import{C as de}from"./clock-DmGtBZEs.js";import{M as z}from"./map-pin-VuyWNYdp.js";import{a as ce,U as me}from"./user-x-DlRg0Hb0.js";import"./heart-CbsRToVe.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=se("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z",key:"1lpok0"}]]),ve=()=>{const{profile:w}=te(),[D,G]=o.useState([]),[t,C]=o.useState(null),[H,A]=o.useState(!1),[j,g]=o.useState(null),[i,h]=o.useState(""),[n,p]=o.useState(null),[c,b]=o.useState({isBooked:!1}),[K,R]=o.useState(!0),[m,d]=o.useState(!1),[P,a]=o.useState(null),[f,x]=o.useState([]),[Z,k]=o.useState(!1),[N,J]=o.useState(null);o.useEffect(()=>{S()},[]),o.useEffect(()=>{if(N&&clearTimeout(N),i.trim().length>=2){const s=setTimeout(()=>{V(i.trim())},300);J(s)}else x([]);return()=>{N&&clearTimeout(N)}},[i]);const V=async s=>{try{d(!0);const{data:r,error:l}=await re(s);l?(console.error("Search error:",l),x([])):x(r||[])}catch(r){console.error("Search exception:",r),x([])}finally{d(!1)}},S=async()=>{try{R(!0);const{data:s,error:r}=await ae();if(r){a("Failed to load sessions"),console.error("Error loading sessions:",r);return}G(s)}catch(s){a("Failed to load sessions"),console.error("Exception loading sessions:",s)}finally{R(!1)}},v=s=>s?new Date(s).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):"",Q=s=>s?new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"",_=async(s,r)=>{try{const{data:l,error:y}=await I.from("attendances").select("id, scanned_at").eq("user_id",s).eq("session_id",r).eq("scan_type","booking").single();return y&&y.code!=="PGRST116"?(console.error("Error checking session booking:",y),{isBooked:!1}):l?{isBooked:!0,bookingId:l.id,bookedAt:l.scanned_at}:{isBooked:!1}}catch(l){return console.error("Exception checking session booking:",l),{isBooked:!1}}},U=s=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s),W=async s=>{try{d(!0),a(null),console.log("Processing QR data:",s);let r=null,l;if(U(s)){console.log("Detected UUID format, searching by UUID...");const u=await oe(s);r=u.data,l=u.error}else{console.log("Detected Personal ID format, searching by Personal ID...");const u=await $(s);r=u.data,l=u.error}if(l||!r){const u=U(s)?"Invalid QR code: UUID not found in system":"Invalid QR code: Personal ID not found";a(u);return}if(r.role!=="attendee"){a("Only attendees can be processed through this system");return}const y=await _(r.id,t.id);p(r),b(y),g(null),k(!1)}catch(r){console.error("QR scan error:",r),a("Failed to process QR scan")}finally{d(!1)}},E=async()=>{if(!i.trim()){a("Please enter a Personal ID");return}try{d(!0),a(null);const{data:s,error:r}=await $(i.trim());if(r||!s){a("Attendee not found with this Personal ID");return}const l=await _(s.id,t.id);p(s),b(l),g(null),h("")}catch(s){console.error("Manual search error:",s),a("Failed to search for attendee")}finally{d(!1)}},Y=async()=>{if(!(!n||!t))try{if(d(!0),a(null),t.max_attendees&&t.current_bookings>=t.max_attendees){a("Session is at full capacity");return}const{data:s,error:r}=await I.from("attendances").insert({user_id:n.id,session_id:t.id,scan_type:"booking",scanned_by:w==null?void 0:w.id}).select().single();if(r){r.code==="23505"?a("Attendee is already registered for this session"):a("Failed to add attendee to session");return}b({isBooked:!0,bookingId:s.id,bookedAt:s.scanned_at}),S()}catch(s){console.error("Add to session error:",s),a("Failed to add attendee to session")}finally{d(!1)}},ee=async()=>{if(!(!n||!t||!c.bookingId))try{d(!0),a(null);const{error:s}=await I.from("attendances").delete().eq("id",c.bookingId);if(s){a("Failed to remove attendee from session");return}b({isBooked:!1}),S()}catch(s){console.error("Remove from session error:",s),a("Failed to remove attendee from session")}finally{d(!1)}},F=()=>{p(null),b({isBooked:!1}),g(null),h(""),a(null)};return K?e.jsx(L,{title:"Info Desk Dashboard",subtitle:"Loading sessions...",children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"})})}):e.jsxs(L,{title:"Info Desk Dashboard",subtitle:"Manage session attendance and bookings",children:[e.jsxs("div",{className:"space-y-8",children:[P&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:"h-5 w-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-700",children:P}),e.jsx("button",{onClick:()=>a(null),className:"ml-auto text-red-500 hover:text-red-700",children:e.jsx(q,{className:"h-5 w-5"})})]})}),!t&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:D.length===0?e.jsxs("div",{className:"col-span-full text-center py-12",children:[e.jsx(X,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Sessions Found"}),e.jsx("p",{className:"text-gray-500",children:"There are no sessions available at the moment."})]}):D.map(s=>e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-orange-100 p-6 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 line-clamp-2",children:s.title}),e.jsx(X,{className:"h-5 w-5 text-orange-500 flex-shrink-0"})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3 line-clamp-2",children:s.description}),e.jsxs("div",{className:"space-y-2 mb-4",children:[s.speaker&&e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx(T,{className:"inline-block h-4 w-4 mr-1"}),s.speaker]}),e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx(de,{className:"inline-block h-4 w-4 mr-1"}),Q(s.start_time)," â€¢ ",v(s.start_time)," - ",v(s.end_time)]}),s.location&&e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx(z,{className:"inline-block h-4 w-4 mr-1"}),s.location]}),e.jsxs("p",{className:"text-sm font-medium text-gray-700",children:[e.jsx(ne,{className:"inline-block h-4 w-4 mr-1"}),s.current_bookings||0,s.max_attendees?`/${s.max_attendees}`:""," bookings"]})]}),e.jsxs("button",{onClick:()=>{C(s),A(!0)},className:"w-full flex items-center justify-center p-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Manage Bookings"]})]},s.id))}),t&&H&&!n&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-orange-100 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:t.title}),e.jsx("p",{className:"text-gray-600 mt-1",children:t.description})]}),e.jsx("button",{onClick:()=>{C(null),A(!1),F()},className:"text-gray-500 hover:text-gray-700 underline text-sm",children:"Back to Sessions"})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("button",{onClick:()=>{g("manual"),h("")},className:`px-6 py-3 rounded-lg font-medium transition-colors ${j==="manual"?"bg-orange-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(O,{className:"h-4 w-4 inline mr-2"}),"Search by Personal ID"]}),e.jsxs("button",{onClick:()=>{g("qr"),h("")},className:`px-6 py-3 rounded-lg font-medium transition-colors ${j==="qr"?"bg-orange-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(B,{className:"h-4 w-4 inline mr-2"}),"QR Scanner"]})]}),j==="manual"&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Search Attendees by Personal ID"}),e.jsxs("div",{className:"flex items-center space-x-3 relative",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:"Start typing Personal ID (e.g., 123456...)",value:i,onChange:s=>h(s.target.value),onKeyDown:s=>s.key==="Enter"&&E(),onBlur:()=>{setTimeout(()=>{x([])},200)},onFocus:()=>f.length>0&&x(f),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-colors"}),i&&e.jsx("button",{onClick:()=>{h(""),x([])},className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(le,{className:"h-5 w-5"})}),f.length>0&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto",children:f.map(s=>e.jsx("button",{onClick:()=>{p(s),_(s.id,t.id).then(b),h(""),x([]),g(null)},className:"w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0 focus:bg-orange-50 focus:outline-none",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[s.first_name," ",s.last_name]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["ID: ",s.personal_id]}),s.university&&e.jsx("p",{className:"text-xs text-gray-500",children:s.university})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.event_entry?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.event_entry?"Inside Event":"Outside Event"}),e.jsx("br",{}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.building_entry?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:s.building_entry?"Inside Building":"Outside Building"})]})})]})},s.id))}),f.length===0&&i.trim().length>=2&&!m&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 px-4 py-3",children:e.jsxs("p",{className:"text-gray-600 text-sm",children:['No attendees found matching "',i,'"']})}),m&&i.trim().length>=2&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-orange-500"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Searching attendees..."})]})})]}),e.jsx("button",{onClick:E,disabled:m||!i.trim(),className:"px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center space-x-2",children:m?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"h-5 w-5"}),e.jsx("span",{children:"Search"})]})})]})]})}),j==="qr"&&e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-16 w-16 text-orange-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"QR Code Scanner"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Scan the attendee's QR code to manage their session booking"}),e.jsxs("button",{onClick:()=>k(!0),className:"px-8 py-4 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium flex items-center space-x-2 mx-auto",children:[e.jsx(B,{className:"h-5 w-5"}),e.jsx("span",{children:"Open QR Scanner"})]})]})]}),t&&n&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-orange-100 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Attendee Details"}),e.jsx("button",{onClick:F,className:"text-gray-500 hover:text-gray-700 underline text-sm",children:"Search Another"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:[n.first_name," ",n.last_name]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(T,{className:"inline-block h-4 w-4 mr-1"}),"ID: ",n.personal_id]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Email: ",n.email]}),n.university&&e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx(z,{className:"inline-block h-4 w-4 mr-1"}),n.university,n.faculty&&` - ${n.faculty}`]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-md font-medium text-gray-900",children:"Current Status"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n.event_entry?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-sm",children:n.event_entry?"Inside Event":"Outside Event"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n.building_entry?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-sm",children:n.building_entry?"Inside Building":"Outside Building"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${c.isBooked?"bg-blue-500":"bg-gray-400"}`}),e.jsx("span",{className:"text-sm",children:c.isBooked?"Session Booked":"Not Booked"})]}),c.isBooked&&c.bookedAt&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Booked: ",new Date(c.bookedAt).toLocaleString()]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"text-md font-medium text-gray-900 mb-2",children:"Session Details"}),e.jsx("p",{className:"text-sm text-gray-700",children:t.title}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[Q(t.start_time)," â€¢ ",v(t.start_time)," - ",v(t.end_time)]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Bookings: ",t.current_bookings||0,t.max_attendees?`/${t.max_attendees}`:""]})]}),e.jsxs("div",{className:"space-y-4",children:[!n.event_entry&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:"h-5 w-5 text-yellow-500 mr-2"}),e.jsx("span",{className:"text-yellow-800 text-sm",children:"Attendee must be inside the event to book sessions"})]})}),t.max_attendees&&t.current_bookings>=t.max_attendees&&!c.isBooked&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(q,{className:"h-5 w-5 text-red-500 mr-2"}),e.jsx("span",{className:"text-red-800 text-sm",children:"Session is at full capacity"})]})}),e.jsx("div",{className:"flex space-x-4",children:c.isBooked?e.jsx("button",{onClick:ee,disabled:m,className:"flex-1 flex items-center justify-center p-3 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:m?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"h-5 w-5 mr-2"}),"Remove from Session"]})}):e.jsx("button",{onClick:Y,disabled:m||!n.event_entry||t.max_attendees&&t.current_bookings>=t.max_attendees,className:"flex-1 flex items-center justify-center p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:m?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"h-5 w-5 mr-2"}),"Add to Session"]})})})]})]})]}),e.jsx(ie,{isOpen:Z,onClose:()=>k(!1),onScan:W,title:"Scan Attendee QR Code",description:"Point your camera at the attendee's QR code to manage their session booking"})]})};export{ve as InfoDeskDashboard};
