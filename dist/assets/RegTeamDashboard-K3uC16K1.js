import{u as K,r as a,l as X,j as e,C as G,A as H,m as P,n as J,p as V}from"./index-_PLFOake.js";import{D as W,X as T,Q as R}from"./DashboardLayout-d5aGyG0Q.js";import{Q as Y}from"./QRScanner-CB6w6_tF.js";import{A as Z}from"./AttendeeCard-ChbRJruu.js";import{S as U}from"./user-x-D7HCBzRh.js";import"./heart-DH_IhmDA.js";import"./map-pin-BreOZY5p.js";import"./clock-BkUeAAXL.js";const S=h=>({...h,current_status:h.event_entry?"inside":"outside"}),le=()=>{K();const[h,C]=a.useState(!1),[m,I]=a.useState("manual"),[n,g]=a.useState(""),[x,f]=a.useState(!1),[p,i]=a.useState([]),[A,c]=a.useState(!1),[b,_]=a.useState(null),[w,d]=a.useState(null),[$,u]=a.useState(!1),[F,D]=a.useState(!1),[y,N]=a.useState(null);a.useEffect(()=>{if(b&&clearTimeout(b),n.trim().length>=2){const s=setTimeout(()=>{O(n.trim())},300);_(s)}else i([]),c(!1);return()=>{b&&clearTimeout(b)}},[n]);const O=async s=>{try{f(!0);const{data:t,error:l}=await X(s);if(l)console.error("Search error:",l),i([]);else{const r=(t||[]).map(j=>S(j));i(r),c(!0)}}catch(t){console.error("Search exception:",t),i([])}finally{f(!1)}},o=(s,t)=>{N({type:s,message:t}),setTimeout(()=>N(null),5e3)},Q=s=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s),k=async()=>{if(!n.trim()){o("error","Please enter a Personal ID");return}try{f(!0);const{data:s,error:t}=await P(n.trim());t||!s?o("error","Personal ID not found"):s.role!=="attendee"?o("error","Only attendees can be processed through this system"):(d(S(s)),u(!0),g(""),c(!1))}catch(s){console.error("Search exception:",s),o("error","Search failed. Please try again.")}finally{f(!1)}},B=s=>{d(s),u(!0),g(""),c(!1),i([])},L=async s=>{try{console.log("Processing QR data:",s);let t=null,l;if(Q(s)){console.log("Detected UUID format, searching by UUID...");const r=await J(s);t=r.data?S(r.data):null,l=r.error}else{console.log("Detected Personal ID format, searching by Personal ID...");const r=await P(s);t=r.data?S(r.data):null,l=r.error}if(l||!t){const r=Q(s)?"Invalid QR code: UUID not found in system":"Invalid QR code: Personal ID not found";o("error",r);return}if(t.role!=="attendee"){o("error","Only attendees can be processed through this system");return}d(t),u(!0)}catch(t){console.error("QR scan error:",t),o("error","Failed to process QR code")}},z=()=>{console.log("Scanner closing from parent..."),C(!1)},E=async s=>{if(w)try{D(!0);const{data:t,error:l}=await V(w.personal_id,s);if(l){o("error",l.message||`Failed to process ${s}`);return}o("success",t.message||`${s.toUpperCase()} scan successful!`);const r=s==="enter"?"inside":"outside";d(j=>j?{...j,current_status:r,last_scan:new Date().toISOString()}:null),setTimeout(()=>{u(!1),d(null)},2e3)}catch(t){console.error("Attendance action error:",t),o("error",`Failed to process ${s}`)}finally{D(!1)}},v=()=>{g(""),i([]),c(!1)},M=()=>{setTimeout(()=>{c(!1)},200)};return e.jsxs(W,{title:"Registration Team Dashboard",subtitle:"Manage attendee registrations and check-ins",children:[y&&e.jsxs("div",{className:`fixed top-4 right-4 z-50 flex items-center space-x-2 px-4 py-3 rounded-lg shadow-lg ${y.type==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,children:[y.type==="success"?e.jsx(G,{className:"h-5 w-5"}):e.jsx(H,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:y.message}),e.jsx("button",{onClick:()=>N(null),className:"ml-2 hover:bg-black hover:bg-opacity-20 rounded p-1",children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("button",{onClick:()=>{I("manual"),v()},className:`px-6 py-3 rounded-lg font-medium transition-colors ${m==="manual"?"bg-orange-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(U,{className:"h-4 w-4 inline mr-2"}),"Search by Personal ID"]}),e.jsxs("button",{onClick:()=>{I("qr"),v()},className:`px-6 py-3 rounded-lg font-medium transition-colors ${m==="qr"?"bg-orange-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(R,{className:"h-4 w-4 inline mr-2"}),"QR Scanner"]})]}),m==="manual"&&e.jsx("div",{className:"bg-white rounded-xl shadow-sm p-6",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Search Attendees by Personal ID"}),e.jsxs("div",{className:"flex items-center space-x-3 relative",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",placeholder:"Start typing Personal ID (e.g., 123456...)",value:n,onChange:s=>g(s.target.value),onKeyDown:s=>s.key==="Enter"&&k(),onBlur:M,onFocus:()=>p.length>0&&c(!0),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-colors"}),n&&e.jsx("button",{onClick:v,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(T,{className:"h-5 w-5"})}),A&&p.length>0&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto",children:p.map(s=>e.jsx("button",{onClick:()=>B(s),className:"w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0 focus:bg-orange-50 focus:outline-none",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900",children:[s.first_name," ",s.last_name]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["ID: ",s.personal_id]}),s.university&&e.jsx("p",{className:"text-xs text-gray-500",children:s.university})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.current_status==="inside"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.current_status==="inside"?"Inside":"Outside"})})]})},s.id))}),A&&p.length===0&&n.trim().length>=2&&!x&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 px-4 py-3",children:e.jsxs("p",{className:"text-gray-600 text-sm",children:['No attendees found matching "',n,'"']})}),x&&n.trim().length>=2&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-orange-500"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Searching attendees..."})]})})]}),e.jsx("button",{onClick:k,disabled:x||!n.trim(),className:"px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center space-x-2",children:x?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-5 w-5"}),e.jsx("span",{children:"Search"})]})})]})]})})}),m==="qr"&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 text-center",children:[e.jsx(R,{className:"h-16 w-16 text-orange-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"QR Code Scanner"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Scan the attendee's QR code to instantly load their information and process entry/exit"}),e.jsxs("button",{onClick:()=>C(!0),className:"px-8 py-4 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium flex items-center space-x-2 mx-auto",children:[e.jsx(R,{className:"h-5 w-5"}),e.jsx("span",{children:"Open QR Scanner"})]})]})]}),e.jsx(Y,{isOpen:h,onClose:z,onScan:L,title:"Scan Attendee QR Code",description:"Point your camera at the attendee's QR code"}),e.jsx(Z,{isOpen:$,onClose:()=>{u(!1),d(null)},attendee:w,onAction:E,loading:F,mode:"registration"})]})};export{le as RegTeamDashboard};
